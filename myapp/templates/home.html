{% extends "base.html" %} {% block title %} Home Page {% endblock %}
{% block content %}

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
{% load static %}

<link rel="stylesheet" href="{% static 'css/home.css' %}">
    
</head>

<body class="bg-light">
    

      <div class="row content-area m-0">
        
        <div class="col-4 d-flex flex-column border-end bg-white border rounded p-3">
            <p>REFERENSER</p>
        </div>
  
       <div class="col-8 d-flex flex-column bg-secondary text-white p-3">
          <div class="flex-grow-1 panel-scroll overflow-auto">
            <div class="chat">
                <div class ="message incoming">
                    <p>
                        Välkommen till Digital Doktor. <br> Jag svarar på medecinska frågor baserat på VGR riktlinjer. <br> Tänk på att DU är ansvarig för alla val som görs. <br>Jag är endast ett stöd som kan svara fel.
                    </p>
                </div>

            </div>

            </div>
  
          <form>
            {% csrf_token %}
            <div class="form-group">
               <textarea class="form-control" id="promptTextBox" rows="5" placeholder="Skriv prompt här..."></textarea>
               <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="useRag" name="use_rag" checked>
                <label class="form-check-label" for="useRag">
                  Använd VGR riktlinjer för att svara på frågan (RAG)
                </label>
                <br><br>
                <button class="btn btn-primary" type="submit">Generera Svar</button>
              </div>

             </div>
           </form>
        </div>
  
      </div>
  
</body>
<script>
    const chatInput = document.querySelector(".form-group textarea")
    const sendChatBtn = document.querySelector(".form-group button");
    const chatbox = document.querySelector(".chat")
    const form = document.querySelector("form");

    let userprompt;

    const createChatDiv = (message, className) => {
        const chatDiv = document.createElement("div");
        chatDiv.classList.add("message", className);
        chatDiv.innerHTML = `<p>${message}</p>`;
        return chatDiv;
    }
/*    

    sendChatBtn.onclick = handleChat;
    //When onclick on the send button for the prompts
    function handleChat()
    {
        event.preventDefault();
        userprompt = chatInput.value.trim();
        if(!userprompt) return; //If it is null we don't want to do anything
        
        chatbox.appendChild(createChatDiv(userprompt,"outgoing"));
        chatInput.value = "";

        const formData = new FormData(chatInput);
        formData.set('use_rag', document.getElementById('useRag').checked);
        
        fetch('{% url "home" %}', {
            method: 'POST',
            body: formData,
            headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            chatbox.appendChild(createChatDiv(data.response,"incoming"));
            //document.getElementById('response').textContent = data.response;
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
*/
    async function handleChat(event) {
        event.preventDefault();
        const userprompt = chatInput.value.trim();
        if (!userprompt) return;

        // Lägg till användarens meddelande
        chatbox.appendChild(createChatDiv(userprompt, "outgoing"));
        chatInput.value = "";

        // Skicka till servern
        try {
            const formData = new FormData();
        formData.append('prompt', userprompt);
        formData.append('use_rag', document.getElementById('useRag').checked);

            const response = await fetch('{% url "home" %}', {

                method: 'POST',
                headers: {
                    'Content-Type': 'XMLHttpRequest',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                },
                body: formData,
            });

            const data = await response.json();
            chatbox.appendChild(createChatDiv(data.response, "incoming"));
            console.log("Server data:", data);
            chatbox.scrollTop = chatbox.scrollHeight;  // Scrolla ned
        } catch (error) {
            console.error('Error:', error);
            chatbox.appendChild(createChatDiv("Ett fel uppstod. Försök igen.", "incoming"));
        }
}

// Lägg till event listener
form.addEventListener("submit", handleChat);
/*
    document.getElementById('promptForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      formData.set('use_rag', document.getElementById('useRag').checked);
      
      fetch('{% url "generate_text" %}', {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById('response').textContent = data.response;
      })
      .catch(error => {
        console.error('Error:', error);
      });
    });
*/
</script>

{% endblock %}